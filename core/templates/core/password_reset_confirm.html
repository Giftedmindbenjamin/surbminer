{% extends 'core/base.html' %}
{% load static %}

{% block title %}Set New Password - Minersurb{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-particles" id="authParticles"></div>
    
    <div class="auth-card">
        <h2>Create New Password</h2>
        <p style="text-align: center; color: var(--text-secondary); margin-bottom: 2rem;">
            Please enter your new password twice so we can verify you typed it correctly
        </p>
        
        {% if validlink %}
            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <form method="POST" class="auth-form" id="newPasswordForm">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="password">New Password</label>
                    <div style="position: relative;">
                        <input type="password" name="password" class="form-control" 
                               id="password" required placeholder="Enter new password">
                        <button type="button" class="password-toggle" id="togglePassword1">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="password-strength-container">
                        <small class="password-hint">
                            <i class="fas fa-info-circle"></i> Password strength
                        </small>
                        <div class="password-strength">
                            <div class="password-strength-bar" id="passwordStrength"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="confirm_password">Confirm New Password</label>
                    <div style="position: relative;">
                        <input type="password" name="confirm_password" class="form-control" 
                               id="confirm_password" required placeholder="Confirm new password">
                        <button type="button" class="password-toggle" id="togglePassword2">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="auth-submit-btn">
                    <i class="fas fa-key"></i> Change Password
                </button>
            </form>
            
        {% else %}
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>Password reset failed</strong>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.95rem;">
                        The password reset link was invalid, possibly because it has already been used.
                        Please request a new password reset.
                    </p>
                </div>
            </div>
            
            <div class="auth-links" style="margin-top: 2rem;">
                <a href="{% url 'core:password_reset' %}"><i class="fas fa-redo"></i> Request New Reset Link</a>
                <span style="margin: 0 1rem; color: var(--text-muted)">|</span>
                <a href="{% url 'core:login' %}"><i class="fas fa-sign-in-alt"></i> Back to Login</a>
            </div>
        {% endif %}
        
        <!-- Password Requirements -->
        <div class="password-requirements" style="margin-top: 2rem; padding: 1.5rem; background: rgba(255, 255, 255, 0.05); border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.1);">
            <h4 style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-lock" style="color: var(--primary-color);"></i>
                Password Requirements
            </h4>
            <div class="requirement" id="reqLength">
                <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                <span>At least 8 characters</span>
            </div>
            <div class="requirement" id="reqUpper">
                <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                <span>At least one uppercase letter</span>
            </div>
            <div class="requirement" id="reqLower">
                <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                <span>At least one lowercase letter</span>
            </div>
            <div class="requirement" id="reqNumber">
                <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                <span>At least one number</span>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    createAuthParticles();
    
    // Password toggle functionality
    const togglePassword1 = document.getElementById('togglePassword1');
    const togglePassword2 = document.getElementById('togglePassword2');
    const passwordInput1 = document.getElementById('password');
    const passwordInput2 = document.getElementById('confirm_password');
    const strengthBar = document.getElementById('passwordStrength');
    
    if (togglePassword1 && passwordInput1) {
        togglePassword1.addEventListener('click', function() {
            const type = passwordInput1.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput1.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
    }
    
    if (togglePassword2 && passwordInput2) {
        togglePassword2.addEventListener('click', function() {
            const type = passwordInput2.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput2.setAttribute('type', type);
            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
    }
    
    // Password strength indicator and requirement checker
    if (passwordInput1 && strengthBar) {
        passwordInput1.addEventListener('input', function() {
            const password = this.value;
            
            // Check requirements
            const hasMinLength = password.length >= 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /[0-9]/.test(password);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
            
            // Update requirement indicators
            updateRequirement('reqLength', hasMinLength);
            updateRequirement('reqUpper', hasUpperCase);
            updateRequirement('reqLower', hasLowerCase);
            updateRequirement('reqNumber', hasNumbers);
            
            // Calculate strength
            let strength = 0;
            if (hasMinLength) strength += 25;
            if (hasUpperCase) strength += 25;
            if (hasLowerCase) strength += 25;
            if (hasNumbers) strength += 25;
            
            strengthBar.style.width = strength + '%';
            strengthBar.className = 'password-strength-bar ';
            
            if (strength < 50) {
                strengthBar.classList.add('strength-weak');
            } else if (strength < 75) {
                strengthBar.classList.add('strength-fair');
            } else if (strength < 100) {
                strengthBar.classList.add('strength-good');
            } else {
                strengthBar.classList.add('strength-strong');
            }
        });
    }
    
    function updateRequirement(elementId, isMet) {
        const element = document.getElementById(elementId);
        if (element) {
            element.classList.remove('met', 'unmet');
            element.classList.add(isMet ? 'met' : 'unmet');
            
            const icon = element.querySelector('i');
            if (icon) {
                icon.style.color = isMet ? 'var(--success-color)' : 'var(--text-muted)';
            }
        }
    }
    
    // Form validation
    const newPasswordForm = document.getElementById('newPasswordForm');
    if (newPasswordForm) {
        newPasswordForm.addEventListener('submit', function(e) {
            const password1 = document.getElementById('password').value;
            const password2 = document.getElementById('confirm_password').value;
            
            if (password1 !== password2) {
                e.preventDefault();
                alert('Passwords do not match!');
                return false;
            }
            
            if (password1.length < 8) {
                e.preventDefault();
                alert('Password must be at least 8 characters long!');
                return false;
            }
        });
    }
});

function createAuthParticles() {
    const container = document.getElementById('authParticles');
    if (!container) return;
    
    const particleCount = 10;
    
    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'auth-particle';
        
        const size = Math.random() * 3 + 1;
        const posX = Math.random() * 100;
        const posY = Math.random() * 100;
        const delay = Math.random() * 5;
        const duration = Math.random() * 10 + 5;
        
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.left = `${posX}%`;
        particle.style.top = `${posY}%`;
        particle.style.animationDelay = `${delay}s`;
        particle.style.animationDuration = `${duration}s`;
        particle.style.opacity = Math.random() * 0.05 + 0.01;
        particle.style.background = 'var(--accent-color)';
        
        container.appendChild(particle);
    }
}
</script>

<style>
.requirement.met {
    color: var(--success-color);
}
.requirement.unmet {
    color: var(--text-muted);
}
</style>
{% endblock %}